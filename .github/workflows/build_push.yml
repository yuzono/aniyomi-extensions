name: Build and Push

on:
  push:
    branches:
      - master
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build and Prepare Repo
        run: |
          # 1. Build all extensions
          ./gradlew assembleDebug -x lint -x check

          # 2. Create repo structure
          mkdir -p repo-files/apk
          mkdir -p repo-files/json_parts

          # 3. Find extensions, copy APKs, and generate JSON parts
          for langdir in src/*; do
            if [ -d "$langdir" ]; then
              LANG=$(basename "$langdir")
              for extdir in "$langdir"/*; do
                if [ -d "$extdir" ]; then
                  buildfile="$extdir/build.gradle"
                  if [ -f "$buildfile" ]; then
                    echo "Processing $extdir"
                    
                    EXT_NAME=$(awk -F"'" '/extName/ {print $2}' "$buildfile")
                    EXT_VERSION=$(awk -F= '/extVersionCode/ {gsub(/[[:space:]]/,"",$2); print $2}' "$buildfile")
                    
                    PKG_NAME=$(basename "$extdir")
                    
                    PKG="eu.kanade.tachiyomi.animeextension.$LANG.$PKG_NAME"
                    APK_NAME="$PKG_NAME-v$EXT_VERSION.apk"
                    
                    APK_PATH=$(find "$extdir" -name "*.apk" -path "*/build/outputs/apk/debug/*" | head -n 1)
                    if [ -f "$APK_PATH" ]; then
                      echo "Found APK for $EXT_NAME at $APK_PATH"
                      cp "$APK_PATH" "repo-files/apk/$APK_NAME"
                      
                      jq -n \
                        --arg name "$EXT_NAME" \
                        --arg pkg "$PKG" \
                        --arg apk "$APK_NAME" \
                        --argjson versionCode "$EXT_VERSION" \
                        --arg lang "$LANG" \
                        '{name: $name, pkg: $pkg, apk: $apk, versionCode: $versionCode, lang: $lang}' \
                        > "repo-files/json_parts/$PKG_NAME.json"
                    fi
                  fi
                fi
              done
            fi
          done

          # 4. Combine JSON parts into index.min.json
          jq -s '.' repo-files/json_parts/*.json > repo-files/index.min.json

          # 5. Clean up
          rm -rf repo-files/json_parts

      - name: Deploy to GitHub Pages (repo branch)
        uses: s0/git-publish-subdir-action@develop
        env:
          REPO: self
          BRANCH: repo # C'est cette branche qui servira de lien Ã  Aniyomi
          FOLDER: repo-files
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}